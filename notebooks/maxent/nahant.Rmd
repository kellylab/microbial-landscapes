---
title: "Pairwise couplings in Nahant"
output: html_notebook
---

```{r}
library(tidyverse)
library(data.table)
library(Matrix)
library(cowplot)
scripts.dir <- "../../scripts/r/"
source(paste0(scripts.dir, "lineage_2_taxonomy.R"))
# this will be bundled into a real package at some point:
source("~/github_bitbucket/wkc.r-utils/df_2_mat.R") 
source("~/github_bitbucket/wkc.r-utils/mat_2_df.R") 

# load data
dt <- fread("../../data/BactNorm.txt", header = TRUE)
dt <- melt(dt, id.vars = c("OTU", "ConsensusLineage"), variable.name = "day",
           value.name = "abundance")
dt[, c("kingdom", "phylum", "class", "order", "family", "genus", "species") :=
     lineage_2_taxonomy(ConsensusLineage), by = ConsensusLineage]
```

## Phylum level analysis
```{r}
phyla <- dt[!is.na(phylum), .(abundance = sum(abundance)), 
            by = .(kingdom, phylum, day)]
phyla[, log.abund := log10(abundance), by = day]
mla <- phyla[!is.infinite(log.abund), min(log.abund)]
phyla[log.abund == -Inf, log.abund := mla]
```

Pairwise correlation between all phyla:
```{r,fig.asp=1}
n.days <- uniqueN(phyla$day)
corr <- phyla %>% 
  dcast(day ~ phylum, value.var = "log.abund") %>% 
  as.data.frame %>% 
  df_2_mat %>% 
  cor(method = "pearson") %>% 
  mat_2_df(row.names = "phylum.i") %>% 
  as.data.table %>% 
  melt(id.vars = "phylum.i", variable.name = "phylum.j", value.name = "correlation")
br <- sort(unique(phyla$phylum))
ggplot(corr, aes(x = phylum.i, y = phylum.j)) +
  geom_tile(aes(fill = correlation)) +
  scale_x_discrete(limits = br) +
  scale_y_discrete(limits = br) +
  scale_fill_gradient2() +
  theme(aspect.ratio = 1, 
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
ggsave("figs/nahant_correlation.pdf")
```

Inverting the correlation matrix gives the putative pairwise interaction matrix between phyla, vis-a-vis [Lezon *et al.*, *PNAS* 2006](http://www.pnas.org/content/103/50/19033.short).
This requires the matrix be nonsingular, which require the number of data points be larger than the number of variables per data point.
Since we're aggregating by phylum, this is true.
For lower taxonomic levels it will probably not be true.
```{r,fig.asp=1}
ntraxn <- corr %>% 
  dcast(phylum.i ~ phylum.j, value.var = "correlation") %>% 
  as.data.frame %>% 
  df_2_mat %>% 
  solve %>% 
  mat_2_df(row.names = "phylum.i") %>% 
  melt(id.vars = "phylum.i", variable.name = "phylum.j", 
       value.name = "coupling")  
ggplot(ntraxn, aes(x = phylum.i, y = phylum.j)) +
  geom_tile(aes(fill = coupling)) +
  scale_fill_gradient2() +
  scale_x_discrete(limits = br) +
  scale_y_discrete(limits = br) +
  theme(aspect.ratio = 1,
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
 ggsave("figs/nahant_coupling.pdf") 
```

Most interactions are positive.
```{r}
ntraxn %>% 
  filter(phylum.i != phylum.j) %>% 
  ggplot(aes(x = coupling)) +
  stat_bin()
```

