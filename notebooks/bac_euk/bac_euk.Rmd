---
title: "Bacterial-eukaryotic associations in Nahant"
output: html_notebook
---

```{r setup}
library(data.table)
library(cowplot)
library(infotheo)

data.dir <- "../../data/"

bac <- fread(paste0(data.dir, "BactNorm.txt"), header = TRUE)
setnames(bac, "ConsensusLineage", "Lineage")
bac <- melt(bac, id.vars = c("OTU", "Lineage"),
                   variable.name = "day")
bac[, day := as.numeric(as.character(day))]
bac[, value := as.numeric(value)]
# merge OTU counts by consensus lineage
bac <- bac[, .(freq = sum(value)), by = .(Lineage, day)]
taxlvls <- c("kingdom", "phylum", "class", "order", "family", "genus", 
             "species")
# bac[, Lineage := gsub(";", "", Lineage)]
bac[, c("foo", taxlvls) := tstrsplit(Lineage, "[[:punct:]]?[[:alpha:]]__")]
bac[, foo := NULL]

euk <- fread(paste0(data.dir, "EukNorm.txt"), header = TRUE)
euk <- melt(euk, id.vars = c("OTU", "Lineage"),
                   variable.name = "day")
euk[, day := as.numeric(as.character(day))]
euk[, value := as.numeric(value)]
# merge OTU counts by consensus lineage
euk <- euk[, .(freq = sum(value)), by = .(Lineage, day)]
# parse lineage
euk[, c("foo", taxlvls) := tstrsplit(Lineage, "[[:punct:]]?[[:alpha:]]__")]
euk[, foo := NULL]
```

# Mutual information

Aggregate frequencies at some taxonomic level:
```{r,message=FALSE}
level <- "class"
inc.lvls <- taxlvls[1:which(taxlvls == level)]
bac.agg <- bac[, .(freq = sum(freq)), by = c("day", inc.lvls)]
euk.agg <- euk[, .(freq = sum(freq)), by = c("day", inc.lvls)]
set(bac.agg, NULL, "label", apply(
  sapply(inc.lvls, function(lvl) bac.agg[, get(lvl)]), 
  1, paste, collapse = "/")
  )
set(euk.agg, NULL, "label", apply(
  sapply(inc.lvls, function(lvl) euk.agg[, get(lvl)]), 
  1, paste, collapse = "/")
  )
# marginal entropies of individual taxa time series
all.dt <- rbind(bac.agg, euk.agg)
setkey(all.dt, kingdom)
mi <- expand.grid(bacteria = all.dt["Bacteria", unique(label)],
                  eukaryote = all.dt["Eukaryota", unique(label)],
                  stringsAsFactors = FALSE)
mi <- as.data.table(mi)
setkey(all.dt, label)
# transform freqs 
# mf <- min(min(bac.agg[freq > 0, freq], euk.agg[freq > 0, freq]))
# bac.agg[, freq := log10(freq + mf)]
# euk.agg[, freq := log10(freq + mf)]
nb <- 10
bac.h <- bac.agg[, .(h = natstobits(entropy(discretize(freq)))),
                 by = label]
euk.h <- euk.agg[, .(h = natstobits(entropy(discretize(freq)))),
                 by = label]
mi[, mi := {
  dt <- all.dt[c(bacteria, eukaryote)]
  dt <- dcast(dt, day ~ label, value.var = "freq")
  # reject time points where one is NA
  dt <- dt[!is.na(get(bacteria)) & !is.na(get(eukaryote))]
  natstobits(mutinformation(
    discretize(dt[, get(bacteria)]), 
    discretize(dt[, get(eukaryote)]))
    )
  
}, by = .(bacteria, eukaryote)]
# calculate uncertainty
mi <- merge(mi, bac.h, by.x = "bacteria", by.y = "label")
mi <- merge(mi, euk.h, by.x = "eukaryote", by.y = "label",
            suffixes = c(".bac", ".euk"))
mi[, ":=" (
  uncertainty.bac = mi / h.bac,
  uncertainty.euk = mi / h.euk
)]
```
```{r ubac-heatmap}
ggplot(mi, aes(x = eukaryote, y = bacteria)) +
  geom_tile(aes(fill = uncertainty.bac)) +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank()) +
  coord_equal() +
  labs(fill = "U(bacteria|eukaryote)")
```

## Comparison with null model
Permute the eukaryote time series to make a null model.
```{r,message=FALSE}
# PERMUTE EUKARYOTE DATA
null.dt <- copy(all.dt)
setkey(null.dt, kingdom)
null.dt["Eukaryota", freq := sample(freq), by = label]
setkey(null.dt, label)
mi[, null.mi := {
  dt <- null.dt[c(bacteria, eukaryote)]
  dt <- dcast(dt, day ~ label, value.var = "freq")
  # reject time points where one is NA
  dt <- dt[!is.na(get(bacteria)) & !is.na(get(eukaryote))]
  dt[, c(eukaryote) := sample(dt[, get(eukaryote)])]
  natstobits(mutinformation(
    discretize(dt[, get(bacteria)]), 
    discretize(dt[, get(eukaryote)]))
    )
}, by = .(bacteria, eukaryote)]
mi[, null.uncertainty.bac := null.mi / h.bac]
```
```{r null-heatmap}
ggplot(mi, aes(x = eukaryote, y = bacteria)) +
  geom_tile(aes(fill = null.uncertainty.bac)) +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank()) +
  coord_equal() +
  labs(fill = "null")
```

The uncertainty-rank distribution for the null looks rather similar.
```{r}
vs.null <- melt(mi, id.vars = c("bacteria", "eukaryote"),
                measure.vars = patterns("uncertainty.bac"),
                value.name = "uncertainty",
                variable.name = "group")
setkey(vs.null, group)
vs.null["null.uncertainty.bac", group := "null"]
vs.null[group == "uncertainty.bac", group := "real"]
vs.null[, rank := frank(-uncertainty, ties.method = "first"), by = group]
```
```{r}
ggplot(vs.null, aes(x = rank, y = uncertainty)) +
  geom_jitter(aes(color = group), size = 0.5)  
```

The probability of having a high uncertainty coefficient in the data compared to the null seems the same as the opposite.
```{r null-ubac-vs-real}
ggplot(mi, aes(x = null.uncertainty.bac, y = uncertainty.bac)) +
  geom_point(size = 0.5) +
  geom_abline(slope = 1, intercept = 0, color = "blue") +
  coord_equal() +
  labs(x = "null", y = "U(bacteria|eukaryote)")
```
The mutual information patterns in the data don't seem significantly different from the null.