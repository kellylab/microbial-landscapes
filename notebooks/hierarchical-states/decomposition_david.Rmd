---
title: "Decomposition of states and time scales in 2 healthy human gut microbiomes"
output: html_notebook
---
```{r setup}
library(tidyverse)
library(data.table)
library(cowplot)
library(ggraph)
library(igraph)
library(infograf)

source("~/github_bitbucket/wkc.r-utils/df_2_mat.R")
source("~/github_bitbucket/wkc.r-utils/mat_2_df.R")

david.jsds <- fread("jsds/david.txt")
source("load_david_data.R")
david.jsds[, c("day.i", "day.j") := lapply(list(day.i, day.j), as.numeric)]
david.jsds[, day.delta := day.j - day.i]
david.jsds[, distance := sqrt(jsd)]

# metadata
setkey(david, subject)
events <- mapply(function(start, end, subject, event) {
  x <- data.table(day = seq(start, end, by = 1), subject = subject, 
                  event = event)
  x
}, start = c(0, 71, 80, 104, 123, 0, 151, 160 ),
end = c(70, 122, 85, 113, david["A", max(as.numeric(day))], 
          150, 159, david["B", max(as.numeric(day))]),
subject = c("A", "A", "A", "A", "A", 
            "B", "B", "B"),
event = c("US (pre)", "travel", "diarrhea 1", "diarrhea 2", "US (post)", 
          "pre-Salmonella", "Salmonella", "post-Salmonella"),
SIMPLIFY = FALSE) %>% rbindlist(use.names = TRUE) 
# collapse event labels per day
unique.day.events <- events[, .(event = paste(event, collapse = " + ")), 
                           by = .(subject, day)]
# merge
david.jsds <- merge(david.jsds, unique.day.events, 
                    by.x = c("subject.i", "day.i"),
                    by.y = c("subject", "day"))
david.jsds <- merge(david.jsds, unique.day.events, 
                    by.x = c("subject.j", "day.j"),
                    by.y = c("subject", "day"),
                    suffixes = c(".i", ".j"))
```

The magnitudes of day-to-day changes in composition don't reflect significant events.
```{r david-stepsizes-day}
setkey(david.jsds, subject.i, subject.j)
event.lims <- events[, .(start = min(day), end = max(day)), 
                     by = .(event, subject)]
event.lims <- event.lims[!grepl("pre", event) & !grepl("post", event)]
event.lims[, event := factor(levels = c("travel", "diarrhea 1", "diarrhea 2",
                                        "Salmonella"), event)]
david.jsds[subject.i == subject.j & day.delta == 1] %>% 
  setnames("subject.i", "subject") %>% 
  ggplot(aes(x = day.i, y = jsd)) +
  geom_rect(data = event.lims, 
    mapping = aes(fill = event, xmin = start, xmax = end, 
                  ymin = 0.1, ymax = 1.05
                  ), inherit.aes = FALSE, alpha = 0.5) +
  geom_point() +
  facet_wrap(~ subject, nrow = 2)
```

Distributions of all distances for all time scales.
We see that both length distributions are multimodal, indicating at least 2 compositional "length scales."
We also see that the vast majority of A distances belong to the lowest mode, while the second lowest mode of B is as high as the lowest, indicating that subject B spends a significant amount of time (relative to the length of the entire measurement).
```{r}
p0 <- ggplot(david.jsds[subject.i == subject.j], aes(x = distance)) 
cdf <- p0 + stat_ecdf(aes(color = subject.i)) + labs(y = "ECDF") +
  labs(color = "subject")
dens <- p0 + stat_density(aes(fill = subject.i), alpha = 0.5, 
                          position = "identity")  +
  labs(fill = "subject")
plot_grid(cdf, dens, nrow = 2, align = "hv")
```

## Paths
```{r david-path-plots,fig.width=7,fig.height=7}
david.subjects <- c("A", "B")
names(david.subjects) <- david.subjects
setkey(david.jsds, subject.i, subject.j)
# make a unique ID string for each sample
david.jsds[, c("sample.i", "sample.j") := lapply(list(
  list(subj = subject.i, day = day.i),
  list(subj = subject.j, day = day.j)), function(il) {
    paste(il$subj, il$day, sep = "_")
  })]
dm <- MakeDistMatrix(david.jsds, "sample.i", "sample.j")
fit <- CoordCMDS(dm)
xform <- fit$points %>% 
  as.data.table
setcolorder(xform, c("sample", "x", "y"))
setkey(xform, sample)
# put sample labels at first 2 columns
setcolorder(david.jsds, c("sample.i", "sample.j",
                         names(david.jsds)[!(grepl("sample", names(david.jsds)))])
            )
david.samples <- unique(david.jsds[, .(sample = sample.i,
                                          subject = subject.i,
                                          day = day.i,
                                          event = event.i)])
# some days are skipped so rank day to make consecutive indices
david.samples[, idx := frank(day), by = subject]
setkey(david.samples, sample)
setkey(david.jsds, sample.i)
david.jsds <- david.jsds[david.samples[, .(sample, idx.i = idx)]] 
setkey(david.jsds, sample.j)
david.jsds <- david.jsds[david.samples[, .(sample, idx.j = idx)]] 
david.jsds[, increment := idx.j - idx.i]
setcolorder(david.samples, c("sample", "subject", "day", "event", "idx"))
```
```{r,fig.asp=1}
#plotting
graf <- graph_from_data_frame(
  david.jsds[subject.i == subject.j & increment == 1],
  directed = TRUE,
  vertices = david.samples
  )
setkey(xform, sample)
xform <- xform[V(graf)$name]
lo <- create_layout(graf, "manual", node.positions = xform)
nsize <- 1
plot_paths_with_var <- function(var, lo) {
  ggraph(lo) +
    geom_edge_link(arrow = arrow(length = unit(3, "points"), type = "closed"),
                   end_cap = square(length = 3, unit = "points"),
                   edge_width = 0.2) +
    geom_node_point(aes_string(color = var), size = nsize) +
    facet_nodes(~ subject) +
    theme_graph(base_family = "Helvetica") +
    theme(aspect.ratio = 1)
}
plot_grid(plotlist = lapply(c("day", "event"), function(var, lo) {
  p <- plot_paths_with_var(var, lo)
  if (var == "day") {
    p <- p + scale_color_distiller(palette = "Blues")
  }
  p
}, lo = lo),
nrow = 2, align = "v")
```

Major separation is between subjects.
The upper right represents states in which the two subjects resembled each other.
Interestingly not all these points seem to be close in time.
Subject B makes a brief excursion to a Subject A-like state post Salmonella.

Eigenvalues by rank:
```{r}
ggplot(fit$eigrank, aes(x = rank, y = value ^ 2)) +
  geom_point()
```

## Louvain

Cluster each subject separately.
```{r}
setkey(david.jsds, subject.i)
clusters <- lapply(c("A", "B"), function(subj, jsds) {
  cl <- jsds[subj, .(sample.i, sample.j, weight = 1 - jsd)] %>% 
          unique %>% 
          .[weight < 0, weight := 0] %>%  #precision error
          graph_from_data_frame(directed = FALSE) %>% 
          simplify(remove.loops = FALSE, edge.attr.comb = "first") %>% 
          cluster_louvain
  mem <- membership(cl)
  data.table(sample = names(mem), cluster = paste0(subj, mem))
}, jsds = david.jsds[subject.i == subject.j]) %>% 
  rbindlist
setkey(clusters, sample)
V(graf)$cluster <- clusters[V(graf)$name, cluster]
lo <- create_layout(graf, "manual", node.positions = xform)
p <- plot_paths_with_var("cluster", lo)
p <- p + scale_color_brewer(palette = "Set3")
p
```
```{r}
setkey(david.samples, sample)
setkey(clusters, sample)
setkey(xform, sample)
david.samples[clusters[xform]] %>% 
  ggplot(aes(x = x, y = y)) +
  stat_density_2d(color = "grey50") +
  geom_point(aes(color = cluster), alpha = 0.5) +
  scale_color_brewer(palette = "Set3") +
  facet_wrap(~ subject) +
  labs(color = "cluster") +
  theme_graph(base_family = "Helvetica") +
  theme(aspect.ratio = 1)
```


```{r}
setkey(david.samples, sample)
setkey(clusters, sample)
david.samples[clusters] %>% 
  ggplot(aes(x = day, y = cluster)) +
  # geom_point(aes(color = event), size = 0.5) +
  geom_line(aes(group = subject, color = event)) +
  scale_color_brewer(palette = "Dark2") +
  facet_wrap(~ subject, nrow = 2, scales = "free_y")
```

### Probability
```{r}
library(philentropy)
david.samples[clusters] %>% 
  .[, {
  n.cl <- .SD[, .N, by = cluster]
  n.ev <- .SD[, .N, by = event]
  n.j <- .SD[, .N, by = .(cluster, event)]
  mi <- MI(n.cl[, N / sum(N)], n.ev[, N / sum(N)], n.j[, N / sum(N)])
  list(mi = mi)
}, by = subject]
```


### Trees

#### Together

Hierarchical clustering reveals 3 major branches: characteristic of Subject A, characteristic of Subject B, and Shared Outlier State. 
```{r david-merged-tree,fig.width=7,fig.height=20}
dm <- dcast(david.div, sample.i ~ sample.j, value.var = "distance")
rn <- dm$sample.i
dm <- dm[, -1]
dm <- as.matrix(dm)
rownames(dm) <- rn
dendro <- as.dendrogram(hclust(dist(dm)))
unique.day.events[, day := as.character(day)]
setkey(unique.day.events, subject, day)
david.samples[, day := as.character(day)]
david.samples[, state := {
  subj <- subject
  dd <- day
  unique.day.events[.(subj, dd), event]
}, by = .(subject, day)]
setkey(david.samples, sample)
dendro <- dendrapply(dendro, function(d) {
  if (is.leaf(d)) {
    samp <- attr(d, "label")
    subj <- david.samples[samp, subject]
    state <- david.samples[samp, state]
    attr(d, "nodePar") <- append(attr(d, "nodePar"), list(subject = subj, 
                                                          state = state))
  }
  d
})
ggraph(dendro, "dendrogram") +
  geom_edge_elbow() +
  geom_node_point(aes(filter = leaf, shape = subject, color = state), size = 1) +
  theme_graph(base_family = "Helvetica") +
  # theme(aspect.ratio = 1) + 
  coord_flip()
```

#### Separate
Clustering separately shows that Subject B has distinct pre- and post-Salmonella states, but the various events in Subject A's life didn't create alternate stable states that were significantly different.

```{r david-event-trees,fig.height=9,fig.width=7}
setkey(david.div, subject.i, subject.j)
dendros <- lapply(david.subjects, function(subj) {
  sd <- david.div[.(subj, subj)]
  dm <- dcast(sd, sample.i ~ sample.j, value.var = "distance")
  rn <- dm$sample.i
  dm <- dm[, -1]
  dm <- as.matrix(dm)
  rownames(dm) <- rn
  hc <- hclust(dist(dm))
  dendro <- as.dendrogram(hc)
  return(dendro)
}
)
unique.day.events[, day := as.character(day)]
# setkey(events, subject)
setkey(unique.day.events, subject, day)
setkey(david.samples, sample)
dendros <- lapply(david.subjects, function(subj) {
  dendro <- dendros[[subj]]
  dendro <- dendrapply(dendro, function(d) {
    if (is.leaf(d)) {
      dday <- david.samples[attr(d, "label"), as.character(day)]
      ev <- unique.day.events[.(subj, dday), event]
      attr(d, "nodePar") <- append(attr(d, "nodePar"), list(
        day = as.numeric(dday),
        event = ev))
    }
    d
  })
  # propagate metadata back up the tree
  dendro <- tree_apply(dendro, function(node, children, depth, tree) {
  if (!is.leaf(node)) {
    events <- sapply(children, function(c) {
      attr(c, "nodePar")$event
    })
    events <- unique(events)
    if (length(events) == 1 & !anyNA(events)) {
      attr(node, "nodePar") <- append(attr(node, "nodePar"), list(event = events))
    } else {
      attr(node, "nodePar") <- append(attr(node, "nodePar"), list(event = NA))
    }
  }
  node
  }, direction = "up")
  dendro
})
dendro.plots <- lapply(dendros, function(dend) {
  ggraph(dend, "dendrogram", circular = TRUE) +
    geom_edge_elbow(aes(color = node2.event)) +
    geom_node_point(aes(filter = leaf, color = day), size = 0.6) +
    scale_color_distiller(palette = "Spectral") +
    theme_graph(base_family = "Helvetica") +
    theme(aspect.ratio = 1)
})
plot_grid(plotlist = dendro.plots, nrow = 2, labels = "AUTO")
```

Subject A doesn't seem to have a distinct "traveling" composition.
Indeed it seems the distance between traveling and US compositions doesn't seem noticeably larger than the distance between US compositions.
Meaning traveling did not destabilize the microbiome any more than baseline fluctuations while living in the US.
Perhaps this is due to many OTUs remaining stable through the duration of travel.

Subject B shows clear pre- and post-Salmonella states, as reported in the original manuscript.
Perhaps the post-Salmonella state is separate because of the extinction of cluster 4 (see original paper) during infection, rendering return to the pre-Salmonella state impossible?