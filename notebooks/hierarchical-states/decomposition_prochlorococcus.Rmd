---
title: "Decomposition of time scales in *Prochlorococcus* time series"
output:
  html_notebook: default
  html_document:
    toc: yes
    toc_depth: 2
    toc_float: yes
  pdf_document: default
---

```{r setup, message=FALSE}
library(tidyverse)
library(data.table)
library(cowplot)
library(ggraph)
library(igraph)
library(imputeTS)
library(infograf)
# source("utils.R")
knitr::opts_chunk$set(
  fig.path = "decomposition_prochlorococcus_figs/",
  fig.keep = "high",
  dev = c("pdf", "png")
)
data.dir <- "../../data/"
source("load_prochlorococcus_data.R")
source("~/github_bitbucket/wkc.r-utils/num_2_fac.R")
```

## Relative abundance time series
```{r,fig.asp=1}
# Average over multiple time points in a single month:
time.series <- prochlorococcus[, .(abundance = mean(abundance)), 
                               by = .(site,
                                      depth,
                                      ecotype,
                                      month,
                                      year,
                                      cal.month)]
time.series[, rel.abund := abundance / sum(abundance),
   by = .(site, depth, month)]
time.series[, log.rel.abund := log10(rel.abund)]
ggplot(time.series, aes(x = month, y = log.rel.abund)) +
  geom_path(aes(group = depth, color = depth)) +
  facet_grid(ecotype ~ site, scales = "free_y") +
  scale_color_gradient(low = "lightblue", high = "blue") +
  labs(y = "log relative abundance")
time.series <- dcast(time.series, site + depth + month ~ ecotype, value.var = "rel.abund")
```

## Spectral analysis
```{r,fig.asp=1}
spectra <- time.series[, {
  m <- as.matrix(.SD) 
  m <- m[order(month),]
  m <- m[, setdiff(colnames(m), "month")] # get rid of month col
  m[is.nan(m)] <- NA
  m <- as.ts(m)
  m <- na.interpolation(m)
  sp <- stats::spectrum(m, plot = FALSE)
  spec <- sp$spec
  spec <- sweep(spec, 2, colMeans(spec, na.rm = TRUE), "/") # normalize
  ll <- lapply(seq_len(ncol(spec)), function(i) spec[, i])
  names(ll) <- sp$snames
  ll$freq <- sp$freq
  ll
  }, 
  by = .(site, depth)]
spectra <- melt(spectra, id.vars = c("site", "depth", "freq"),
                variable.name = "ecotype",
                value.name = "spectrum")
spectra %>% 
  ggplot(aes(x = freq, y = spectrum)) +
  geom_vline(xintercept = 1 / 12, color = "red") +
  geom_line(aes(group = depth, color = depth)) +
  scale_color_gradient(low = "lightblue", high = "blue") +
  facet_grid(ecotype ~ site, scales = "free_y") + 
  labs(x = "frequency (1/month)")
```

Red line indicates periodicity of 1 year.
Relative height of peaks gives relative magnitude of periodic fluctuations at that time scale.
This shows that not all ecotypes at all depths are most strongly driven by annual cycling.
E.g. e9312 apparently experiences strong annual cycling at all depths except 100.
NATL experiences annual cycling at all depths but it is relatively weaker at depths 160-200.

## Jensen-Shannon divergence

Read pre-computed JSDs.
See `make_all_jsds.R` for details.
```{r}
jsds <- fread("jsds/prochlorococcus.txt")
jsds[, distance := sqrt(jsd)]
# convert time stamps to ordinal
setnames(jsds, c("month.i", "month.j"), c("cal.month.i", "cal.month.j"))
jsds[, c("month.i", "month.j") := mapply(function(yr, mo) {
  mo + 12 * (yr - min(yr))
},
yr = list(year.i, year.j), 
mo = list(cal.month.i, cal.month.j), 
SIMPLIFY = FALSE)
]
jsds[, c("sample.i", "sample.j") := mapply(function(mo, dp) {
  paste(mo, dp, sep = "_")
},
mo = list(month.i, month.j),
dp = list(depth.i, depth.j),
SIMPLIFY = FALSE)
]
jsds[, delta := month.j - month.i]
```

### Time-lagged JSD
```{r,fig.asp=1}
setkey(jsds, site)
plot_grid(plotlist = lapply(c("bats", "hot"), function(si, jsds) {
  sd <- jsds[si][depth.i == depth.j]
  sd[, c("month.i", "month.j") := lapply(list(month.i, month.j), num_2_fac)]
  ggplot(sd, aes(x = month.i, y = month.j)) +
    geom_tile(aes(fill = jsd)) +
    facet_wrap(~ depth.i, nrow = 2, scales = "free") +
    theme(axis.text = element_blank(),
          axis.ticks = element_blank(),
          aspect.ratio = 1) +
    labs(title = si, x = "month", y = "month")
},
jsds = jsds
), ncol = 1)
```

### Correlograms
```{r, fig.asp=1}
plot_grid(plotlist = lapply(c("bats", "hot"), function(si, jsds) {
  sd <- jsds[si][delta > 0 & depth.i == depth.j]
  ggplot(sd, aes(x = delta, y = jsd)) +
    geom_point(size = 0.1, alpha = 0.1) +
    geom_smooth() +
    facet_wrap(~ depth.i, nrow = 2, scales = "free") +
    theme(axis.text.x = element_text(size = 8)) +
    labs(title = si)
},
jsds = jsds
), ncol = 1)
```

## Paths
```{r}
setkey(jsds, site)
sites <- c(bats = "bats", hot = "hot")
mds.out <- lapply(sites, function(sit, jsds) {
  site.dt <- jsds[sit]
  edges <- site.dt[delta == 1, .(month.i, month.j)]
  vertices <- unique(jsds[, .(sample.i, month.i, depth.i, year.i, cal.month.i)])
  dm <- MakeDistMatrix(site.dt, "sample.i", "sample.j")
  coords <- CoordCMDS(dm)
}, jsds = jsds)
# eigenvalues
eig <- lapply(mds.out, function(d) {
  d[["eigrank"]]
}
) %>% 
  rbindlist(idcol = "site")  
ggplot(eig, aes(x = rank, y = value ^ 2)) +
  geom_point(aes(color = site)) 
```

Plots:
```{r}
# nodes in the upcoming path plot
samples <- unique(prochlorococcus[, .(site,
                                      month,
                                      year,
                                      cal.month,
                                      depth)])
samples[, sample := paste(month, depth, sep = "_")]
xform <- lapply(sites, function(si, out) {
  out[[si]]$points
},
out = mds.out) %>% 
  rbindlist(idcol = "site")
setkey(samples, site, sample)
setkey(xform, site, sample)
xform <- samples[xform]
setcolorder(xform, c("sample", setdiff(names(xform), "sample")))
setkey(xform, site)
setkey(jsds, site)
grafs <- lapply(c(bats = "bats", hot = "hot"), 
                function(si, coords, jsds, xf) {
  coord <- coords[[si]][["points"]]
  j <- jsds[si]
  ej <- j[delta == 1 & depth.i == depth.j, 
          .(sample.i, sample.j, depth = depth.i, weight = 1 - jsd)] # edges
  vt <- xf[si]
  graph_from_data_frame(ej, 
                        directed = FALSE, 
                        vertices = vt)
},
coords = mds.out, jsds = jsds, xf = xform)
```
```{r,fig.asp=1.8}
plot_grid(plotlist = lapply(sites, function(si, graf, coord, mbreaks) {
  gf <- graf[[si]]
  pts <- coord[si, .(sample, x, y)]
  ggraph(gf, "manual", node.positions = pts) +
    geom_edge_link(arrow = arrow(length = unit(5, "points")),
                   end_cap = square(length = 5, unit = "points")
                   ) +
    geom_node_point(aes(color = cal.month), size = 1) +
    scale_color_gradientn(values = scales::rescale(mbreaks),
                          colors = c("blue", "green4", "yellow", "orange",
                                     "blue")
                          ) +
    labs(title = si) +
    theme_graph(base_family = "Helvetica") +
    theme(aspect.ratio = 1) +
    facet_wrap(~ depth, ncol = 4)
},
graf = grafs, 
coord = xform, 
mbreaks = c(1, 3, 6, 9, 12) # Jan, plus months of solstices + equinoxes
),
ncol = 1)
```


## Modularization using Louvain algorithm
```{r}
setkey(jsds, site)
modules <- lapply(sites, function(si, jsds) {
  d <- jsds[si, .(sample.i, sample.j, month.i, month.j, weight = 1 - jsd)]
  d <- d[month.j > month.i]
  g <- graph_from_data_frame(d, directed = FALSE)
  cluster_fast_greedy(g)
},
jsds = jsds)
modules <- lapply(modules, function(com) {
  mem <- membership(com)
  data.table(sample = names(mem), cluster = as.numeric(mem))
}
) %>% rbindlist(idcol = "site")
```

Merge cluster labels with data:
```{r}
# assign samples to clusters
xform <- merge(xform, modules, by = c("site", "sample")) 
# assign paired samples to clusters
jsds <- merge(jsds, modules, by.x = c("site", "sample.i"), 
              by.y = c("site", "sample")) 
jsds <- merge(jsds, modules, by.x = c("site", "sample.j"),
              by.y = c("site", "sample"), 
              suffixes = c(".i", ".j")) 
# label path plots
setkey(modules, site, sample)
grafs <- lapply(sites, function(si, grafs, mods) {
  g <- grafs[[si]]
  cl <- mods[.(si, V(g)$name), cluster]
  V(g)$cluster <- cl
  g
},
grafs = grafs, mods = modules)
```
```{r,fig.asp=1.8}
plot_grid(plotlist = lapply(sites, function(si, grafs, xform) {
  g <- grafs[[si]]
  xf <- xform[si,  .(sample, x, y)]
  ggraph(g, "manual", node.positions = xf) +
    geom_edge_link(arrow = arrow(length = unit(5, "points")),
                   end_cap = square(length = 5, unit = "points")) +
    geom_node_point(aes(color = as.character(cluster)), size = 1) +
    labs(color = "state", title = si) +
    facet_wrap(~ depth, nrow = 3) +
    theme_graph(base_family = "Helvetica") +
    theme(aspect.ratio = 1) 
},
grafs = grafs, xform = xform),
nrow = 2)
```

### Density
```{r,fig.asp=1.8}
setkey(xform, site)
xform[, cluster := as.character(cluster)]
plot_grid(plotlist = lapply(sites, function(si, xform) {
  xf <- xform[si]
  ggplot(xf, aes(x = x, y = y)) +
    geom_density_2d(color = "grey50") +
    geom_point(aes(color = cluster)) +
    labs(color = "state") +
    theme_graph(base_family = "Helvetica") +
    theme(aspect.ratio = 1) +
    labs(title = si) +
    facet_wrap(~ depth, ncol = 4)
}, xform = xform),
nrow = 2)
```

### Dynamical landscape as vector fields
```{r,fig.asp=1.8}
setkey(jsds, site)
setkey(xform, site)
bins <- 10
plot_grid(plotlist = lapply(sites, function(si, xform, jsds, bins) {
  xf <- xform[si, .(site, sample, x, y)]
  j <- jsds[si]
  merged <- merge(j, xf, by.x = c("site", "sample.i"), 
                  by.y = c("site", "sample"))
  merged <- merge(merged, xf, by.x = c("site", "sample.j"), 
                  by.y = c("site", "sample"), 
                  suffixes = c(".i", ".j"))
  merged[, c("dx", "dy") := list(
    x.j - x.i,
    y.j - y.i
  )]
  # binning
  merged[, bin.x := floor(scales::rescale(x.i, to = c(0, bins)))]
  merged[, bin.y := floor(scales::rescale(y.i, to = c(0, bins))), by = site]
  mean.vecs <- merged[, .(dx = mean(dx),
                          dy = mean(dy),
                          depth = depth.i,
                          n = .N), by = .(bin.x, bin.y, depth.i)]
  ggplot(mean.vecs, aes(x = bin.x, y = bin.y, 
                        xend = bin.x + dx, yend = bin.y + dy)) +
    geom_segment(aes(color = n), arrow = arrow(length = unit(5, "points"))) +
    facet_wrap(~ depth) +
    theme_graph(base_family = "Helvetica") +
    theme(aspect.ratio = 1) +
    labs(title = si)
}, xform = xform, jsds = jsds[delta == 1 & depth.i == depth.j], bins = bins),
nrow = 2)
```

### Years as replicates
```{r,fig.asp=3}
setkey(jsds, site, delta)
setkey(xform, site)
plot_grid(plotlist = lapply(sites, function(si, grafs, xform) {
  g <- grafs[[si]]
  coor <- xform[si, .(sample, x, y)]
  # hack: HOT only has 1 point for 2008
  if (si == "hot") {
    g <- induced_subgraph(g, V(g)$year != 2008)
    coor <- coor[sample %in% V(g)$name]
  }
  ggraph(g, "manual", node.positions = coor) +
    geom_edge_link(aes(color = num_2_fac(node2.cluster)), 
                   arrow = arrow(length = unit(5, "points"))#,
                   # end_cap = square(length = 1, unit = "points")
                   ) +
    # geom_node_point(aes(color = as.character(cluster)), size = 1) +
    labs(color = "state", title = si, edge_colour = "state") +
    facet_graph(depth ~ year, row_type = "node") +
    theme_graph(base_family = "Helvetica") +
    theme(aspect.ratio = 1) 
}, grafs = grafs, xform = xform),
ncol = 1)
```

### Temporal distribution of states and transitions
```{r,fig.asp=1}
setkey(xform, site)
plot_grid(plotlist = lapply(sites, function(si, xform) {
  xf <- xform[si]
  ggplot(xf, aes(x = cal.month)) +
    geom_freqpoly(aes(color = cluster), position = "dodge", bins = 12) +
    labs(title = si) +
    facet_wrap(~ depth, nrow = 3)
}, xform = xform),
nrow = 2)
```

```{r,fig.asp=1}
jsds[, transition := paste(cluster.i, cluster.j, sep = "->")]
setkey(jsds, site)
plot_grid(plotlist = lapply(sites, function(si, jsd) {
  j <- jsd[si]
  ggplot(j[delta == 1 & depth.i == depth.j], 
         aes(x = num_2_fac(cal.month.i))) +
    stat_count(aes(fill = transition)) +
    scale_x_discrete(breaks = as.character(seq(to = 112, by = 3))) +
    labs(title = si, x = "calendar month") +
    facet_wrap(~ depth.i, nrow = 3)
}, jsd = jsds),
nrow = 2)
```
