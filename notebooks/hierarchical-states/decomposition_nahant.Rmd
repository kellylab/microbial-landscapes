---
title: "Decomposition of states and time scales in the Nahant dataset"
output: html_notebook
---

```{r setup}
library(tidyverse)
library(data.table)
library(cowplot)
library(ggraph)
library(igraph)
source("utils.R")
source("~/github_bitbucket/wkc.r-utils/df_2_mat.R")

knitr::opts_chunk$set(
  fig.path = "decomposition_nahant_figs/",
  fig.keep = "high",
  dev = c("pdf")
)
data.dir <- "../../data/"
script.dir <- "../../scripts/r/"
nahant.bac <- fread(paste0(data.dir, "BactNorm.txt"), header = TRUE)
nahant.bac <- melt(nahant.bac, id.vars = c("OTU", "ConsensusLineage"), 
                   variable.name = "day")
nahant.bac <- nahant.bac[, day := as.numeric(as.character(day))]
nahant.bac <- nahant.bac[, value := as.numeric(value)]
# merge OTU counts by consensus lineage
nahant.bac <- nahant.bac[, .(freq = sum(value)), by = .(ConsensusLineage, day)]
# parse lineage
# nothing is mapped to species resolution
nahant.bac <- nahant.bac[, ConsensusLineage := gsub(";", "", ConsensusLineage)]
nahant.bac <- nahant.bac[, c("foo", "kingdom", "phylum", "class", "order", "family",
                             "genus") := tstrsplit(ConsensusLineage, 
                                                   "[[:alpha:]]__")]
nahant.bac <- nahant.bac[, foo := NULL]
```

Here we aggregate all reads that map to the same phylum, which results in a manageable number of variables.
But one could just as well aggregate at any other taxonomic level or not at all.
```{r}
phyla <- nahant.bac[kingdom != "" & phylum != "", .(freq = sum(freq)), 
           by = .(day, phylum)] 
```

```{r nahant-ts, fig.asp=1}
phyla %>% 
  group_by(phylum) %>% 
  mutate(freq = scales::rescale(freq)) %>% 
  ggplot(aes(x = as.numeric(day), y = freq)) +
  theme(strip.text = element_text(size = 10),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)
        ) +
  scale_y_continuous(breaks = c(0, 0.5, 1)) +
  geom_line(aes(group = phylum)) +
  facet_wrap(~ phylum, ncol = 4) +
  labs(y = "frequency (normalized)")
```

We can look at the spectral density of the phyla time series.
Phyla with peaks in the low frequencies exhibit slow fluctuations.
It seems there really are slow and broad-spectrum taxa at this level.
```{r nahant-phyla-spectra}
phyla.spec <- phyla %>%
  dcast(day ~ phylum, value.var = "freq") %>% 
  select(-day) %>% 
  stats::spectrum(plot = FALSE)
phyla.spec <- data.table(cbind(phyla.spec$freq, phyla.spec$spec)) %>% 
  setnames(c("freq", phyla.spec$snames)) %>% 
  melt(id.vars = "freq", variable.name = "phylum")
phyla.spec %>% 
  group_by(phylum) %>% 
  mutate(value = value / sum(value)) %>% 
  ggplot(aes(x = freq, y = phylum)) +
  labs(x = "frequency (1/day)") +
  geom_tile(aes(fill = value)) 
```

# R there statez?

Are there qualitative coarse-grainable compositional states in the Nahant data?
```{r nahant-composition-clustering}
phyla[, day := as.character(day)]
days <- unique(phyla[, day])
day.div <- data.table(expand.grid(day.i = days, day.j = days))
day.div[, ":=" (day.i = as.character(day.i), 
                           day.j = as.character(day.j))]
setkey(phyla, day)
day.div[, jsd := {
  if (day.i == day.j) {
    0
  } else {
    sd <- phyla[c(day.i, day.j)]
    sd <- dcast(sd, phylum ~ day, value.var = "freq")
    m <- as.matrix(sd[, 2:3])
    d <- genJSD(m)
    d
  }
}, by = .(day.i, day.j)]
day.div[, distance := sqrt(jsd)]
```

Layout the samples by Jensen-Shannon distance using `mds` algorithm.
Color by day so as to see temporal progression.
Hierarchically cluster by JS distance.

```{r nahant-composition-clustering-plot, fig.height=7, fig.width=7}
edges <- cbind(days[-length(days)], days[-1])
graph <- graph_from_data_frame(edges, directed = FALSE,
                               vertices = data.table(id = days,
                                                     day = as.numeric(days)))
dm <- MakeDistMatrix(day.div, "day.i", "day.j")
fit <- CoordCMDS(dm)
xform <- fit$points
# order
setkey(xform, sample)
xform <- xform[V(graph)$name]
layout <- create_layout(graph, "manual", node.positions = xform)
p1 <- ggraph(layout) +
  geom_edge_link(arrow = arrow(type = "closed", 
                               length = unit(5, "points")),
                 edge_width = 0.2,
                 end_cap = square(length = 5, unit = "points")
                 ) +
  geom_node_point(aes(color = day)) +
  theme_graph(base_family = "Helvetica") +
  scale_color_distiller(palette = "Spectral") 
# clustering
hc <- hclust(dist(dm))
dendro <- as.dendrogram(hc)
dendro <- dendrapply(dendro, function(d) {
  if (is.leaf(d)) {
    attr(d, "nodePar") <- list(day = as.numeric(attr(d, "label")))
  }
  d
})
p2 <- ggraph(dendro, "dendrogram") +
  geom_edge_elbow() +
  # geom_node_text(aes(filter = leaf, color = day, label = day), angle = 90, size = 2) +
  geom_node_point(aes(filter = leaf, color = day)) +
  scale_color_distiller(palette = "Spectral") +
  theme_graph(base_family = "Helvetica") #+
  # theme(aspect.ratio = 1)
plot_grid(p1, p2, nrow = 2, align = "hv", labels = c("A", "B"))
```
These data show a clear transition between stable states around day 240.
These two states form the two major branches at the lowest level of the hierarchical clustering.

The eigenvalues of the MDS transform show that information is well preserved:
```{r bats-mds-eigen}
ggplot(fit$eigrank, aes(x = rank, y = value ^ 2)) +
  geom_point()
```


## Statistics of dynamics 

Distribution of daily compositional step sizes.
The Maxwell-Boltzmann/lognormal shape to the density at $\Delta(t) = 1$ 
suggests that under this time resolution the change in composition behaves
like some kind of random walk, with a characteristic step size and rare changes of larger magnitude.
```{r nahant-day-deltas, fig.width=7,fig.height=6}
day.div <- day.div[, day.delta := as.numeric(day.j) - as.numeric(day.i)]
p1 <- ggplot(day.div[day.delta == 1,], aes(x = distance)) +
  stat_bin(bins = 30) 
p2 <- ggplot(day.div[day.delta == 1], aes(x = as.numeric(day.i), y = distance)) +
  geom_point() + 
  # stat_smooth() + 
  labs(x = "day i")
plot_grid(p1, p2, nrow = 2, labels = "AUTO", align = "hv")
day.div[day.delta > 0] %>% 
  mutate(group = as.factor(floor(day.delta / 10) * 10),
         ddelta = as.factor(day.delta %% 10)) %>% 
  ggplot(aes(x = distance)) +
  stat_bin(bins = 30, position = "identity") +
  scale_color_brewer(palette = "Spectral") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, 
                                   size = 7
                                   ),
        axis.text.y = element_text(size = 6)
        ) +
  facet_grid(group ~ ddelta, scales = "free_y")
```

Compositional distance as function of interval.
This is sort of an autocorrelation spectrum.
There are no peaks in this 'spectrum' suggesting there are no characteristic
time scales of periodic behavior.
Since there is only one major state transition in these data, it could also be interpreted as the period of state transitions being longer than the observation time, when interpreted as periodic.
```{r nahant-sim-interval}
br <- days[seq(1, length(days), by = 5)]
ggplot(day.div, aes(x = day.i, y = day.j)) +
  geom_tile(aes(fill = jsd)) +
  scale_x_discrete(breaks = br) +
  scale_y_discrete(breaks = br) +
  theme(aspect.ratio = 1,
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
ggplot(day.div[day.delta > 0], aes(x = day.delta, y = jsd)) + 
  geom_point(size = 1) + 
  stat_smooth(aes(linetype = "mean"))  +
  # geom_line(aes(y = mn.dist, linetype = "mean"), tl, color = "blue", size = 2) +
  labs(linetype = "", x = "interval (days)")
```

## Modularization

Try to find states as modules in the network of JSDs between timepoints.

### Greedy algorithm (Louvain)

Reference: [Blondel 2008](https://arxiv.org/abs/0803.0476).

```{r}
day.div[, similarity := 1 - jsd]
graf <- graph_from_data_frame(day.div[as.numeric(day.i) < as.numeric(day.j), 
                                      .(day.i, day.j, weight = similarity)], 
                              directed = FALSE, 
                              vertices = unique(day.div[, day.i]))
system.time(clust <- cluster_louvain(graf))
modularity(clust)
membership(clust)
```

```{r}
clust.dt <- data.table(cluster = as.character(membership(clust)),
                       day = names(membership(clust)))
setkey(clust.dt, day)
V(graph)$cluster <- clust.dt[V(graph)$name, cluster]
layout <- create_layout(graph, "manual", node.positions = xform)
ggraph(layout) +
  geom_edge_link(arrow = arrow(type = "closed", 
                               length = unit(5, "points")),
                 edge_width = 0.2,
                 end_cap = square(length = 5, unit = "points")
                 ) +
  geom_node_point(aes(color = cluster)) +
  theme_graph(base_family = "Helvetica") 
```

### Time-lagged state correlation
```{r}
day.div <- merge(day.div, clust.dt, by.x = "day.i", by.y = "day")
day.div <- merge(day.div, clust.dt, by.x = "day.j", by.y = "day",
                 suffixes = c(".i", ".j"))
day.div[, same := cluster.i == cluster.j]
ggplot(day.div[day.delta > 0], aes(x = day.delta, y = 1* same)) +
  geom_smooth()
```

